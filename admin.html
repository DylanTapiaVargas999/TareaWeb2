<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador - UPT</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="nav-brand">
                <img src="https://pbs.twimg.com/profile_images/971067995215843329/OYOGVRee_400x400.jpg" alt="UPT Logo" class="logo-upt">
                <div class="nav-brand-text">
                    <span class="nav-brand-title">Panel de Administración</span>
                    <span class="nav-brand-subtitle">Universidad Privada de Tacna</span>
                </div>
            </div>
            <div class="nav-user">
                <span id="adminName">Administrador</span>
                <button id="logoutBtn" class="btn btn-secondary">Cerrar Sesión</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Navegación entre secciones -->
        <div class="admin-tabs" style="margin-bottom: 2rem;">
            <button class="tab-btn active" data-section="servidores">Solicitudes de Servidores</button>
            <button class="tab-btn" data-section="arduino">Solicitudes de Arduino</button>
        </div>

        <!-- SECCIÓN SERVIDORES -->
        <div class="admin-section" id="servidoresSection" style="display: block;">
        
        <!-- Título de Sección -->
        <div class="card">
            <h2>Dashboard de Solicitudes de Servidores</h2>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="stat-card total">
                <h3>TOTAL</h3>
                <div class="stat-value" id="totalSolicitudes">0</div>
            </div>
            <div class="stat-card pendientes">
                <h3>PENDIENTES</h3>
                <div class="stat-value" id="totalPendientes">0</div>
            </div>
            <div class="stat-card aprobadas">
                <h3>APROBADAS</h3>
                <div class="stat-value" id="totalAprobadas">0</div>
            </div>
            <div class="stat-card rechazadas">
                <h3>RECHAZADAS</h3>
                <div class="stat-value" id="totalRechazadas">0</div>
            </div>
        </div>

        <!-- Calendario y Gráfico en Grid -->
        <div class="charts-grid">
            <!-- Calendario a la izquierda -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>Calendario de Ocupación</h3>
                    <div class="calendar-nav">
                        <button id="prevMonth" class="btn btn-secondary">Anterior</button>
                        <span id="currentMonth" style="font-weight: 600; color: var(--upt-azul-oscuro);"></span>
                        <button id="nextMonth" class="btn btn-secondary">Siguiente</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div>
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mié</div>
                    <div class="calendar-day-header">Jue</div>
                    <div class="calendar-day-header">Vie</div>
                    <div class="calendar-day-header">Sáb</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>

            <!-- Gráfica a la derecha -->
            <div class="chart-container">
                <h3>Demanda por Servidor</h3>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Tabla de Solicitudes -->
        <div class="card">
            <h2>Gestión de Solicitudes</h2>
            
            <div class="filters">
                <button class="filter-btn active" data-filter="TODAS">Todas</button>
                <button class="filter-btn" data-filter="PENDIENTE">Pendientes</button>
                <button class="filter-btn" data-filter="APROBADA">Aprobadas</button>
                <button class="filter-btn" data-filter="RECHAZADA">Rechazadas</button>
            </div>

            <div class="table-container">
                <table id="solicitudesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Alumno</th>
                            <th>Docente</th>
                            <th>Curso</th>
                            <th>Fecha</th>
                            <th>Horario</th>
                            <th>Servidor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="solicitudesTableBody">
                        <tr>
                            <td colspan="9" class="loading">Cargando solicitudes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
        <!-- FIN SECCIÓN SERVIDORES -->

        <!-- SECCIÓN ARDUINO -->
        <div class="admin-section" id="arduinoSection" style="display: none;">
        
        <!-- Título de Sección -->
        <div class="card">
            <h2>Dashboard de Solicitudes Arduino</h2>
        </div>

        <!-- Dashboard Arduino -->
        <div class="dashboard">
            <div class="stat-card total">
                <h3>TOTAL</h3>
                <div class="stat-value" id="totalSolicitudesArduino">0</div>
            </div>
            <div class="stat-card pendientes">
                <h3>PENDIENTES</h3>
                <div class="stat-value" id="totalPendientesArduino">0</div>
            </div>
            <div class="stat-card aprobadas">
                <h3>APROBADAS</h3>
                <div class="stat-value" id="totalAprobadasArduino">0</div>
            </div>
            <div class="stat-card rechazadas">
                <h3>RECHAZADAS</h3>
                <div class="stat-value" id="totalRechazadasArduino">0</div>
            </div>
        </div>

        <!-- Calendario y Gráfico Arduino en Grid -->
        <div class="charts-grid">
            <!-- Calendario Arduino a la izquierda -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>Calendario de Ocupación - Arduino</h3>
                    <div class="calendar-nav">
                        <button id="prevMonthArduino" class="btn btn-secondary">Anterior</button>
                        <span id="currentMonthArduino" style="font-weight: 600; color: var(--upt-azul-oscuro);"></span>
                        <button id="nextMonthArduino" class="btn btn-secondary">Siguiente</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div>
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mié</div>
                    <div class="calendar-day-header">Jue</div>
                    <div class="calendar-day-header">Vie</div>
                    <div class="calendar-day-header">Sáb</div>
                </div>
                <div id="calendarGridArduino" class="calendar-grid"></div>
            </div>

            <!-- Gráfica de componentes a la derecha -->
            <div class="chart-container">
                <h3>Componentes Más Solicitados</h3>
                <canvas id="componentesChart"></canvas>
            </div>
        </div>

        <!-- Tabla de Solicitudes Arduino -->
        <div class="card">
            <h2>Gestión de Solicitudes Arduino</h2>
            
            <div class="filters">
                <button class="filter-btn-arduino active" data-filter="TODAS">Todas</button>
                <button class="filter-btn-arduino" data-filter="PENDIENTE">Pendientes</button>
                <button class="filter-btn-arduino" data-filter="APROBADA">Aprobadas</button>
                <button class="filter-btn-arduino" data-filter="RECHAZADA">Rechazadas</button>
            </div>

            <div class="table-container">
                <table id="solicitudesArduinoTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Alumno</th>
                            <th>Docente</th>
                            <th>Curso</th>
                            <th>Fecha</th>
                            <th>Horario</th>
                            <th>Tipo Alquiler</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="solicitudesArduinoTableBody">
                        <tr>
                            <td colspan="9" class="loading">Cargando solicitudes de Arduino...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
        <!-- FIN SECCIÓN ARDUINO -->

    </div>

    <!-- Modal Detalles -->
    <div id="detallesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalles de la Solicitud</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="detallesContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal Aprobar -->
    <div id="aprobarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Aprobar Solicitud</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="aprobarForm">
                    <div class="form-group">
                        <label for="lugarAsignado">Lugar Asignado (Laboratorio/Sala) *</label>
                        <input type="text" id="lugarAsignado" placeholder="Ej: Laboratorio 302" required>
                    </div>
                    <div class="form-group">
                        <label for="notasAprobacion">Notas Adicionales</label>
                        <textarea id="notasAprobacion" rows="3" placeholder="Instrucciones adicionales para el alumno..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success btn-large">Confirmar Aprobación</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Rechazar -->
    <div id="rechazarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rechazar Solicitud</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="rechazarForm">
                    <div class="form-group">
                        <label for="motivoRechazo">Motivo del Rechazo *</label>
                        <textarea id="motivoRechazo" rows="4" placeholder="Explica por qué se rechaza esta solicitud..." required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger btn-large">Confirmar Rechazo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modales para Arduino -->
    <!-- Modal Detalles Arduino -->
    <div id="detallesArduinoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Detalles de la Solicitud Arduino</h2>
            <div id="detallesArduinoContent"></div>
        </div>
    </div>

    <!-- Modal Aprobar Arduino -->
    <div id="aprobarArduinoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Aprobar Solicitud Arduino</h2>
            <form id="aprobarArduinoForm">
                <div class="form-group">
                    <label for="lugarAsignadoArduino">Lugar de Retiro *</label>
                    <input type="text" id="lugarAsignadoArduino" placeholder="Ej: Almacén de Electrónica - Piso 3" required>
                </div>
                <div class="form-group">
                    <label for="notasAprobacionArduino">Notas Adicionales</label>
                    <textarea id="notasAprobacionArduino" rows="3" placeholder="Instrucciones adicionales (horario de retiro, precauciones, etc.)..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">Confirmar Aprobación</button>
            </form>
        </div>
    </div>

    <!-- Modal Rechazar Arduino -->
    <div id="rechazarArduinoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Rechazar Solicitud Arduino</h2>
            <form id="rechazarArduinoForm">
                <div class="form-group">
                    <label for="motivoRechazoArduino">Motivo del Rechazo *</label>
                    <textarea id="motivoRechazoArduino" rows="4" placeholder="Explica por qué se rechaza esta solicitud..." required></textarea>
                </div>
                <button type="submit" class="btn btn-danger">Confirmar Rechazo</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, collection, query, getDocs, doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDDmyY3n9s1Wcyx0-0G3MCXc0zfRd47ge8",
            authDomain: "tareaweb2-59553.firebaseapp.com",
            projectId: "tareaweb2-59553",
            storageBucket: "tareaweb2-59553.firebasestorage.app",
            messagingSenderId: "353313714839",
            appId: "1:353313714839:web:685bfa9931e3096364efd2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allSolicitudes = [];
    let serverSolicitudes = []; 
        let currentFilter = 'TODAS';
        let selectedSolicitudId = null;
        let barChart = null;
        let currentCalendarDate = new Date();
    let currentAdminName = null;
        
        // Variables para Arduino
    let allSolicitudesArduino = [];
    let currentFilterArduino = 'TODAS';
    let selectedSolicitudArduinoId = null;
    let componentesChart = null;
    let currentCalendarDateArduino = new Date();
        let currentSection = 'servidores';

        // Auth check - Verificar que es administrador mediante Firestore (rol)
        onAuthStateChanged(auth, async (user) => {
            

            console.log('Usuario autenticado:', user.email);

            try {
                const adminDocRef = doc(db, 'administradores', user.uid);
                const adminSnap = await getDoc(adminDocRef);

                if (adminSnap.exists() && adminSnap.data().rol === 'admin') {
                    console.log('✅ Acceso de administrador confirmado (rol en Firestore)');
                    const nombre = adminSnap.data().nombre || 'Administrador';
                    currentAdminName = nombre;
                    document.getElementById('adminName').textContent = nombre;
                    loadSolicitudes();
                    loadSolicitudesArduino();
                } else {
                    console.log('❌ Usuario no es administrador (documento/firestore):', user.email);
                    alert('❌ Acceso denegado. Solo administradores pueden acceder a este panel.');
                    await signOut(auth);
                    currentAdminName = null;
                    window.location.href = 'login_register.html';
                }
            } catch (err) {
                console.error('Error verificando rol de admin:', err);
                alert('❌ Error verificando permisos. Intenta iniciar sesión nuevamente.');
                await signOut(auth);
                currentAdminName = null;
                window.location.href = 'login_register.html';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'login_register.html';
        });

        // Navegación entre secciones (Servidores / Arduino)
        document.querySelectorAll('.admin-tabs .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Actualizar botones activos
                document.querySelectorAll('.admin-tabs .tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Mostrar/ocultar secciones
                const section = btn.dataset.section;
                currentSection = section;
                
                document.getElementById('servidoresSection').style.display = 
                    section === 'servidores' ? 'block' : 'none';
                document.getElementById('arduinoSection').style.display = 
                    section === 'arduino' ? 'block' : 'none';
            });
        });

        // Load solicitudes
        async function loadSolicitudes() {
            try {
                // Consulta simple sin orderBy para evitar problemas de índice
                const q = query(collection(db, 'solicitudes'));
                const querySnapshot = await getDocs(q);
                
                // Guardamos exclusivamente los documentos de la colección 'solicitudes'
                serverSolicitudes = [];
                querySnapshot.forEach((doc) => {
                    serverSolicitudes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Ordenar en el cliente
                serverSolicitudes.sort((a, b) => {
                    const dateA = new Date(a.fechaSolicitud || 0);
                    const dateB = new Date(b.fechaSolicitud || 0);
                    return dateB - dateA; // Más reciente primero
                });

                // Mantener also allSolicitudes para compatibilidad (si se usa en otros lugares)
                allSolicitudes = serverSolicitudes.slice();

                updateStats();
                updateCharts();
                renderTable();
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                alert('❌ Error al cargar solicitudes: ' + error.message);
            }
        }

        // Update stats
        function updateStats() {
            const total = serverSolicitudes.length;
            const pendientes = serverSolicitudes.filter(s => s.estado === 'PENDIENTE').length;
            const aprobadas = serverSolicitudes.filter(s => s.estado === 'ACEPTADO').length;
            const rechazadas = serverSolicitudes.filter(s => s.estado === 'RECHAZADO').length;

            document.getElementById('totalSolicitudes').textContent = total;
            document.getElementById('totalPendientes').textContent = pendientes;
            document.getElementById('totalAprobadas').textContent = aprobadas;
            document.getElementById('totalRechazadas').textContent = rechazadas;
        }

        // Update charts and calendar
        function updateCharts() {
            // Renderizar calendario
            renderCalendar();

            // Bar Chart - Demanda por servidor (todas las solicitudes)
            const servidores = {};
            serverSolicitudes.forEach(s => {
                servidores[s.servidor] = (servidores[s.servidor] || 0) + 1;
            });

            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChart) barChart.destroy();
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(servidores),
                    datasets: [{
                        label: 'Solicitudes',
                        data: Object.values(servidores),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Renderizar calendario
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Actualizar título
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            // Obtener primer día del mes y total de días
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Crear grid del calendario
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Espacios vacíos antes del primer día
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }

            // Días del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Buscar solicitudes para esta fecha (solo solicitudes de SERVIDORES)
                // NOTA: se incluyen solicitudes en cualquier estado excepto las explícitamente rechazadas,
                // para que el calendario marque días con reservaciones pendientes/aprobadas.
                const solicitudesDelDia = serverSolicitudes.filter(s =>
                    s.fecha === dateStr && s.servidor && s.estado !== 'RECHAZADO'
                );

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                // Marcar día actual
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.style.background = 'var(--upt-amarillo)';
                    dayCell.style.fontWeight = '700';
                }

                // Colorear según ocupación
                if (solicitudesDelDia.length > 0) {
                    dayCell.classList.add('has-solicitudes');
                    
                    // Tooltip con información (mostrar servidor y horario)
                    const servidoresInfo = solicitudesDelDia.map(s => {
                        const entrada = s.horaEntrada || s.hora || (s.horario ? s.horario.split('-')[0] : '—');
                        const salida = s.horaSalida || (s.hora ? s.hora.split('-')[1] : '—');
                        return `${s.servidor} (${entrada}-${salida})`;
                    }).join('\n');
                    dayCell.title = `${solicitudesDelDia.length} reserva(s):\n${servidoresInfo}`;
                    
                    // Click para mostrar detalles
                    dayCell.addEventListener('click', () => {
                        mostrarDetallesDia(dateStr, solicitudesDelDia);
                    });
                }

                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${solicitudesDelDia.length > 0 ? `<div class="solicitud-count">${solicitudesDelDia.length} reserva(s)</div>` : ''}
                `;

                grid.appendChild(dayCell);
            }
        }

        // Mostrar detalles de un día específico (lista compacta tipo informe)
        function mostrarDetallesDia(fecha, solicitudes) {
            const content = document.getElementById('detallesContent');
            const serverOnly = (solicitudes || []).filter(s => s.servidor);

            if (serverOnly.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p class="empty-state-text">No hay solicitudes de servidores para este día</p>
                        <p class="empty-state-subtext">Fecha: ${fecha}</p>
                    </div>
                `;
                document.getElementById('detallesModal').style.display = 'block';
                return;
            }

            content.innerHTML = `
                <h3 style="margin-top:0;">Solicitudes para ${fecha}</h3>
                ${serverOnly.map(s => `
                    <div class="detalle-dia" style="border-left:4px solid #14a14a; padding-left:1rem; margin-bottom:1rem;">
                        <p><strong>Servidor:</strong> ${s.servidor || '—'}</p>
                        <p><strong>Horario:</strong> ${s.horaEntrada || s.hora || '—'} - ${s.horaSalida || ''}</p>
                        <p><strong>Responsable:</strong> ${s.nombreResponsable || '—'} ${s.codigoResponsable ? `(${s.codigoResponsable})` : ''}</p>
                        <p><strong>Curso:</strong> ${s.curso || '—'}</p>
                        <p><strong>Docente:</strong> ${s.docente || '—'}</p>
                        <button class="btn btn-info" onclick="window.verDetalles('${s.id}')" style="margin-top:0.5rem;">Ver más detalles</button>
                    </div>
                `).join('')}
            `;
            document.getElementById('detallesModal').style.display = 'block';
        }

        // Navegación del calendario
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderTable();
            });
        });

        // Render table
        function renderTable() {
            const tbody = document.getElementById('solicitudesTableBody');
            const filtered = currentFilter === 'TODAS' ? 
                serverSolicitudes : 
                serverSolicitudes.filter(s => s.estado === currentFilter);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-message">No hay solicitudes</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map((s, index) => {
                const statusClass = s.estado === 'ACEPTADO' ? 'status-aceptado' : 
                                   s.estado === 'RECHAZADO' ? 'status-rechazado' : 'status-pendiente';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.nombreResponsable}<br><small>${s.codigoResponsable}</small></td>
                        <td>${s.docente}</td>
                        <td>${s.curso}</td>
                        <td>${s.fecha}</td>
                        <td>${s.horaEntrada} - ${s.horaSalida}</td>
                        <td>${s.servidor}</td>
                        <td><span class="status-badge ${statusClass}">${s.estado}</span></td>
                        <td class="action-btns">
                            <button class="btn btn-info btn-sm" onclick="window.verDetalles('${s.id}')">Detalles</button>
                            ${s.estado === 'PENDIENTE' ? `
                                <button class="btn btn-success btn-sm" onclick="window.abrirAprobar('${s.id}')">Aprobar</button>
                                <button class="btn btn-danger btn-sm" onclick="window.abrirRechazar('${s.id}')">Rechazar</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Modals
        const modals = ['detalles', 'aprobar', 'rechazar'];
        modals.forEach(modalName => {
            const modal = document.getElementById(`${modalName}Modal`);
            const span = modal.querySelector('.close');
            span.onclick = () => modal.style.display = 'none';
        });

        window.onclick = (event) => {
            modals.forEach(modalName => {
                const modal = document.getElementById(`${modalName}Modal`);
                if (event.target == modal) modal.style.display = 'none';
            });
        };

        // Helper para renderizar integrantes que soporta ambas estructuras:
        // - array de strings: ['Juan', 'Ana']
        // - array de objetos: [{nombre:'Juan', codigo:'123'}]
        function renderIntegrantesHTML(integrantes) {
            if (!integrantes || integrantes.length === 0) return '<li>—</li>';
            return integrantes.map(i => {
                if (typeof i === 'string') return `<li>${i}</li>`;
                if (i && i.nombre && i.codigo) return `<li>${i.nombre} (${i.codigo})</li>`;
                // If it's an object with missing parts, fallback to JSON
                return `<li>${JSON.stringify(i)}</li>`;
            }).join('');
        }

        // Ver detalles
        window.verDetalles = (id) => {
            // Buscar solo en las solicitudes de servidores
            const solicitud = serverSolicitudes.find(s => s.id === id);
            if (!solicitud) {
                const content = document.getElementById('detallesContent');
                content.innerHTML = `<p>No se encontró la solicitud de servidor solicitada.</p>`;
                document.getElementById('detallesModal').style.display = 'block';
                return;
            }
            const content = document.getElementById('detallesContent');
            
            content.innerHTML = `
                <div class="detalle-section">
                    <h3>Responsable</h3>
                    <p><strong>Nombre:</strong> ${solicitud.nombreResponsable}</p>
                    <p><strong>Código:</strong> ${solicitud.codigoResponsable}</p>
                    <p><strong>Email:</strong> ${solicitud.emailAlumno}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Contexto Académico</h3>
                    <p><strong>Docente:</strong> ${solicitud.docente}</p>
                    <p><strong>Curso:</strong> ${solicitud.curso}</p>
                    <p><strong>Semestre:</strong> ${solicitud.semestre}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Horario</h3>
                    <p><strong>Fecha:</strong> ${solicitud.fecha}</p>
                    <p><strong>Entrada:</strong> ${solicitud.horaEntrada}</p>
                    <p><strong>Salida:</strong> ${solicitud.horaSalida}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Recursos</h3>
                    <p><strong>Servidor:</strong> ${solicitud.servidor}</p>
                    <p><strong>Tipo:</strong> ${solicitud.tipoServidor}</p>
                    <p><strong>Características:</strong> ${solicitud.caracteristicas}</p>
                    <p><strong>Accesorios:</strong> ${solicitud.accesorios.join(', ') || 'Ninguno'}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Integrantes del Grupo</h3>
                    <ul>
                        ${renderIntegrantesHTML(solicitud.integrantes)}
                    </ul>
                </div>

                <div class="detalle-section">
                    <h3>Administrado por</h3>
                    <p>${solicitud.administrador ? solicitud.administrador : '—'}</p>
                </div>

                <div class="detalle-section">
                    <h3>Estado</h3>
                    <p><strong>Estado Actual:</strong> <span class="status-badge status-${solicitud.estado.toLowerCase()}">${solicitud.estado}</span></p>
                    ${solicitud.respuestaAdmin ? `<p><strong>Respuesta:</strong> ${solicitud.respuestaAdmin}</p>` : ''}
                </div>
            `;
            
            document.getElementById('detallesModal').style.display = 'block';
        };

        // Abrir modal aprobar
        window.abrirAprobar = (id) => {
            selectedSolicitudId = id;
            document.getElementById('aprobarModal').style.display = 'block';
        };

        // Abrir modal rechazar
        window.abrirRechazar = (id) => {
            selectedSolicitudId = id;
            document.getElementById('rechazarModal').style.display = 'block';
        };

        // Aprobar
        document.getElementById('aprobarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lugar = document.getElementById('lugarAsignado').value;
            const notas = document.getElementById('notasAprobacion').value;
            
            const respuesta = `Solicitud APROBADA. Lugar asignado: ${lugar}. ${notas ? 'Notas: ' + notas : ''}`;
            
            try {
                await updateDoc(doc(db, 'solicitudes', selectedSolicitudId), {
                    estado: 'ACEPTADO',
                    respuestaAdmin: respuesta,
                    fechaRespuesta: new Date().toISOString(),
                    administrador: currentAdminName
                });
                
                alert('✅ Solicitud aprobada exitosamente');
                document.getElementById('aprobarModal').style.display = 'none';
                document.getElementById('aprobarForm').reset();
                loadSolicitudes();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });

        // Rechazar
        document.getElementById('rechazarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const motivo = document.getElementById('motivoRechazo').value;
            
            try {
                await updateDoc(doc(db, 'solicitudes', selectedSolicitudId), {
                    estado: 'RECHAZADO',
                    respuestaAdmin: `Solicitud RECHAZADA. Motivo: ${motivo}`,
                    fechaRespuesta: new Date().toISOString(),
                    administrador: currentAdminName
                });
                
                alert('✅ Solicitud rechazada');
                document.getElementById('rechazarModal').style.display = 'none';
                document.getElementById('rechazarForm').reset();
                loadSolicitudes();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });

        // ===============================================
        // FUNCIONES PARA ARDUINO
        // ===============================================

        // Load solicitudes Arduino
        async function loadSolicitudesArduino() {
            try {
                const q = query(collection(db, 'solicitudes_arduino'));
                const querySnapshot = await getDocs(q);
                
                allSolicitudesArduino = [];
                querySnapshot.forEach((doc) => {
                    allSolicitudesArduino.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Ordenar en el cliente
                allSolicitudesArduino.sort((a, b) => {
                    const dateA = new Date(a.fechaSolicitud || 0);
                    const dateB = new Date(b.fechaSolicitud || 0);
                    return dateB - dateA;
                });

                updateStatsArduino();
                updateChartsArduino();
                renderTableArduino();
            } catch (error) {
                console.error('Error cargando solicitudes Arduino:', error);
                alert('❌ Error al cargar solicitudes Arduino: ' + error.message);
            }
        }

        // Update stats Arduino
        function updateStatsArduino() {
            const total = allSolicitudesArduino.length;
            const pendientes = allSolicitudesArduino.filter(s => s.estado === 'PENDIENTE').length;
            const aprobadas = allSolicitudesArduino.filter(s => s.estado === 'ACEPTADO').length;
            const rechazadas = allSolicitudesArduino.filter(s => s.estado === 'RECHAZADO').length;

            document.getElementById('totalSolicitudesArduino').textContent = total;
            document.getElementById('totalPendientesArduino').textContent = pendientes;
            document.getElementById('totalAprobadasArduino').textContent = aprobadas;
            document.getElementById('totalRechazadasArduino').textContent = rechazadas;
        }

        // Update charts Arduino
        function updateChartsArduino() {
            // Gráfica de tipo de alquiler
            const tiposAlquiler = {
                'completo': 0,
                'individual': 0
            };
            
            allSolicitudesArduino.forEach(s => {
                tiposAlquiler[s.tipoAlquiler] = (tiposAlquiler[s.tipoAlquiler] || 0) + 1;
            });

            // 'Tipo de Alquiler' pie chart removed — mantenemos conteo si es necesario en otro lado.

            // Gráfica de componentes más solicitados
            const componentes = {};
            allSolicitudesArduino.forEach(s => {
                if (s.tipoAlquiler === 'individual' && s.partesSeleccionadas) {
                    s.partesSeleccionadas.forEach(parte => {
                        componentes[parte] = (componentes[parte] || 0) + 1;
                    });
                }
            });

            // Ordenar y tomar top 10
            const topComponentes = Object.entries(componentes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const componentesCtx = document.getElementById('componentesChart').getContext('2d');
            if (componentesChart) componentesChart.destroy();
            componentesChart = new Chart(componentesCtx, {
                type: 'bar',
                data: {
                    labels: topComponentes.map(c => c[0]),
                    datasets: [{
                        label: 'Veces Solicitado',
                        data: topComponentes.map(c => c[1]),
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Render calendar Arduino
            renderCalendarArduino();
        }

        // Render calendario Arduino
        function renderCalendarArduino() {
            const year = currentCalendarDateArduino.getFullYear();
            const month = currentCalendarDateArduino.getMonth();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('currentMonthArduino').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendarGridArduino');
            grid.innerHTML = '';

            // Espacios vacíos antes del primer día
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }

            // Días del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Buscar solicitudes Arduino para esta fecha (excluir RECHAZADO) para marcar pendientes y aceptadas
                const solicitudesDelDia = allSolicitudesArduino.filter(s =>
                    s.fecha === dateStr && s.estado !== 'RECHAZADO'
                );

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';

                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.style.background = 'var(--upt-amarillo)';
                    dayCell.style.fontWeight = '700';
                }

                if (solicitudesDelDia.length > 0) {
                    dayCell.classList.add('has-solicitudes');

                    const info = solicitudesDelDia.map(s => {
                        const entrada = s.horaEntrada || s.hora || (s.horario ? s.horario.split('-')[0] : '—');
                        const salida = s.horaSalida || (s.hora ? s.hora.split('-')[1] : '—');
                        return `${s.nombreResponsable || s.codigoResponsable || '—'} (${entrada}-${salida})`;
                    }).join('\n');
                    dayCell.title = `${solicitudesDelDia.length} reserva(s) Arduino:\n${info}`;
                    dayCell.addEventListener('click', () => {
                        mostrarDetallesDiaArduino(dateStr, solicitudesDelDia);
                    });
                }

                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${solicitudesDelDia.length > 0 ? `<div class="solicitud-count">${solicitudesDelDia.length} reservas</div>` : ''}
                `;

                grid.appendChild(dayCell);
            }
        }

        // Mostrar detalles de un día para Arduino (lista compacta tipo informe)
        function mostrarDetallesDiaArduino(fecha, solicitudes) {
            const content = document.getElementById('detallesArduinoContent');
            const arr = (solicitudes || []).filter(s => s.estado !== 'RECHAZADO');
            if (arr.length === 0) {
                content.innerHTML = `<h3>Solicitudes para ${fecha}</h3><p>No hay solicitudes de Arduino para este día.</p>`;
                document.getElementById('detallesArduinoModal').style.display = 'block';
                return;
            }

            content.innerHTML = `
                <h3 style="margin-top:0;">Solicitudes para ${fecha}</h3>
                ${arr.map(s => `
                    <div class="detalle-dia" style="border-left:4px solid #14a14a; padding-left:1rem; margin-bottom:1rem;">
                        <p><strong>Responsable:</strong> ${s.nombreResponsable || '—'} ${s.codigoResponsable ? `(${s.codigoResponsable})` : ''}</p>
                        <p><strong>Horario:</strong> ${s.horaEntrada || s.hora || '—'} - ${s.horaSalida || ''}</p>
                        <p><strong>Tipo:</strong> ${s.tipoAlquiler === 'completo' ? 'Kit Completo' : 'Partes Individuales'}</p>
                        <button class="btn btn-info" onclick="window.verDetallesArduino('${s.id}')" style="margin-top:0.25rem;">Ver más detalles</button>
                    </div>
                `).join('')}
            `;
            document.getElementById('detallesArduinoModal').style.display = 'block';
        }

        // Navegación calendario Arduino
        document.getElementById('prevMonthArduino').addEventListener('click', () => {
            currentCalendarDateArduino.setMonth(currentCalendarDateArduino.getMonth() - 1);
            renderCalendarArduino();
        });

        document.getElementById('nextMonthArduino').addEventListener('click', () => {
            currentCalendarDateArduino.setMonth(currentCalendarDateArduino.getMonth() + 1);
            renderCalendarArduino();
        });

        // Filter buttons Arduino
        document.querySelectorAll('.filter-btn-arduino').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn-arduino').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilterArduino = btn.dataset.filter;
                renderTableArduino();
            });
        });

        // Render table Arduino
        function renderTableArduino() {
            const tbody = document.getElementById('solicitudesArduinoTableBody');
            const filtered = currentFilterArduino === 'TODAS' ? 
                allSolicitudesArduino : 
                allSolicitudesArduino.filter(s => s.estado === currentFilterArduino);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-message">No hay solicitudes de Arduino</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map((s, index) => {
                const statusClass = s.estado === 'ACEPTADO' ? 'status-aceptado' : 
                                   s.estado === 'RECHAZADO' ? 'status-rechazado' : 'status-pendiente';
                
                const tipoTexto = s.tipoAlquiler === 'completo' ? 'Kit Completo' : 'Partes Individuales';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.nombreResponsable}<br><small>${s.codigoResponsable}</small></td>
                        <td>${s.docente}</td>
                        <td>${s.curso}</td>
                        <td>${s.fecha}</td>
                        <td>${s.horaEntrada} - ${s.horaSalida}</td>
                        <td>${tipoTexto}</td>
                        <td><span class="status-badge ${statusClass}">${s.estado}</span></td>
                        <td class="action-btns">
                            <button class="btn btn-info btn-sm" onclick="window.verDetallesArduino('${s.id}')">Detalles</button>
                            ${s.estado === 'PENDIENTE' ? `
                                <button class="btn btn-success btn-sm" onclick="window.abrirAprobarArduino('${s.id}')">Aprobar</button>
                                <button class="btn btn-danger btn-sm" onclick="window.abrirRechazarArduino('${s.id}')">Rechazar</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Modals Arduino
        const modalsArduino = ['detallesArduino', 'aprobarArduino', 'rechazarArduino'];
        modalsArduino.forEach(modalName => {
            const modal = document.getElementById(`${modalName}Modal`);
            const span = modal.querySelector('.close');
            span.onclick = () => modal.style.display = 'none';
        });

        // Ver detalles Arduino
        window.verDetallesArduino = (id) => {
            const solicitud = allSolicitudesArduino.find(s => s.id === id);
            const content = document.getElementById('detallesArduinoContent');
            
            const partesHTML = solicitud.tipoAlquiler === 'completo' ? 
                '<p><strong>Tipo:</strong> Kit Completo Arduino</p>' :
                `<p><strong>Partes Seleccionadas:</strong></p>
                 <ul>${solicitud.partesSeleccionadas.map(p => `<li>${p}</li>`).join('')}</ul>`;
            
            content.innerHTML = `
                <div class="detalle-section">
                    <h3>Responsable</h3>
                    <p><strong>Nombre:</strong> ${solicitud.nombreResponsable}</p>
                    <p><strong>Código:</strong> ${solicitud.codigoResponsable}</p>
                    <p><strong>Email:</strong> ${solicitud.emailAlumno}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Contexto Académico</h3>
                    <p><strong>Docente:</strong> ${solicitud.docente}</p>
                    <p><strong>Curso:</strong> ${solicitud.curso}</p>
                    <p><strong>Semestre:</strong> ${solicitud.semestre}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Horario</h3>
                    <p><strong>Fecha:</strong> ${solicitud.fecha}</p>
                    <p><strong>Entrada:</strong> ${solicitud.horaEntrada}</p>
                    <p><strong>Salida:</strong> ${solicitud.horaSalida}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Recursos Arduino</h3>
                    ${partesHTML}
                </div>
                
                <div class="detalle-section">
                    <h3>Propósito</h3>
                    <p>${solicitud.proposito}</p>
                </div>
                
                <div class="detalle-section">
                    <h3>Integrantes del Grupo</h3>
                    <ul>
                        ${renderIntegrantesHTML(solicitud.integrantes)}
                    </ul>
                </div>

                <div class="detalle-section">
                    <h3>Administrado por</h3>
                    <p>${solicitud.administrador ? solicitud.administrador : '—'}</p>
                </div>

                <div class="detalle-section">
                    <h3>Estado</h3>
                    <p><strong>Estado Actual:</strong> <span class="status-badge status-${solicitud.estado.toLowerCase()}">${solicitud.estado}</span></p>
                    ${solicitud.respuestaAdmin ? `<p><strong>Respuesta:</strong> ${solicitud.respuestaAdmin}</p>` : ''}
                </div>
            `;
            
            document.getElementById('detallesArduinoModal').style.display = 'block';
        };

        // Abrir modal aprobar Arduino
        window.abrirAprobarArduino = (id) => {
            selectedSolicitudArduinoId = id;
            document.getElementById('aprobarArduinoModal').style.display = 'block';
        };

        // Abrir modal rechazar Arduino
        window.abrirRechazarArduino = (id) => {
            selectedSolicitudArduinoId = id;
            document.getElementById('rechazarArduinoModal').style.display = 'block';
        };

        // Aprobar Arduino
        document.getElementById('aprobarArduinoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lugar = document.getElementById('lugarAsignadoArduino').value;
            const notas = document.getElementById('notasAprobacionArduino').value;
            
            const respuesta = `Solicitud APROBADA. Lugar de retiro: ${lugar}. ${notas ? 'Notas: ' + notas : ''}`;
            
            try {
                await updateDoc(doc(db, 'solicitudes_arduino', selectedSolicitudArduinoId), {
                    estado: 'ACEPTADO',
                    respuestaAdmin: respuesta,
                    fechaRespuesta: new Date().toISOString(),
                    administrador: currentAdminName
                });
                
                alert('✅ Solicitud Arduino aprobada exitosamente');
                document.getElementById('aprobarArduinoModal').style.display = 'none';
                document.getElementById('aprobarArduinoForm').reset();
                loadSolicitudesArduino();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });

        // Rechazar Arduino
        document.getElementById('rechazarArduinoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const motivo = document.getElementById('motivoRechazoArduino').value;
            
            try {
                await updateDoc(doc(db, 'solicitudes_arduino', selectedSolicitudArduinoId), {
                    estado: 'RECHAZADO',
                    respuestaAdmin: `Solicitud RECHAZADA. Motivo: ${motivo}`,
                    fechaRespuesta: new Date().toISOString(),
                    administrador: currentAdminName
                });
                
                alert('✅ Solicitud Arduino rechazada');
                document.getElementById('rechazarArduinoModal').style.display = 'none';
                document.getElementById('rechazarArduinoForm').reset();
                loadSolicitudesArduino();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });
    </script>
</body>
</html>
